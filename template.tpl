___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook Conversions API Client",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Facebook",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "A server-side client template that listens and translates event information from the Facebook Pixel Library.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[]


___SANDBOXED_JS_FOR_SERVER___

// Imports for Sandboxed Javascript.
const claimRequest = require('claimRequest');
const getRemoteAddress = require('getRemoteAddress');
const getRequestBody = require('getRequestBody');
const getRequestHeader = require('getRequestHeader');
const getRequestMethod = require('getRequestMethod');
const getRequestPath = require('getRequestPath');
const getRequestQueryParameters = require('getRequestQueryParameters');
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const requestPath = getRequestPath();
const returnResponse = require('returnResponse');
const runContainer = require('runContainer');
const sendHttpGet = require('sendHttpGet');
const setPixelResponse = require('setPixelResponse');
const setResponseBody = require('setResponseBody');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const templateDataStorage = require('templateDataStorage');

// Processing unit for Phase 1 events fired from fbevents.js

const proxyResponse = (response, headers, statusCode) => {
  setResponseStatus(statusCode);
  setResponseBody(response);
  for (const key in headers) {
    setResponseHeader(key, headers[key]);
  }
  returnResponse();
};

if(requestPath === '/en_US/fbevents.js') {
  logToConsole('Processing /en_US/fbevents.js request...');

  claimRequest();
  const now = getTimestampMillis();
  const twenty_minutes_ago = now - (20 * 60 * 1000);
  if (templateDataStorage.getItemCopy('fbevents_js') == null || templateDataStorage.getItemCopy('fbevents_stored_at') < twenty_minutes_ago) {
    sendHttpGet('https://connect.facebook.net/en_US/fbevents.js', (statusCode, headers, body) => {
      if (statusCode === 200) {
        templateDataStorage.setItemCopy('fbevents_js', body);
        templateDataStorage.setItemCopy('fbevents_headers', headers);
        templateDataStorage.setItemCopy('fbevents_stored_at', now);
      }
      proxyResponse(body, headers, statusCode);
    }, {timeout: 5000});
  } else {
    proxyResponse(
      templateDataStorage.getItemCopy('fbevents_js'),
      templateDataStorage.getItemCopy('fbevents_headers'),
      200
    );
  }

  logToConsole('Processed /en_US/fbevents.js request.');
}

if(requestPath === '/tr') {
  let params;

  if(getRequestMethod() == 'POST'){
    params = JSON.parse(getRequestBody());
  } else{
    params = getRequestQueryParameters();
  }

  logToConsole('Processing /tr event. Request:' + JSON.stringify(params));

  claimRequest();
  const eventModel = {};
  eventModel.event_name = params.ev;
  eventModel.event_time = makeInteger(params.ts/1000);
  eventModel.event_id = params.eid;
  eventModel.page_location = params.dl;
  if(params.test_event_code) eventModel.test_event_code = params.test_event_code;

  // Based on GTM common event data parameters -- https://developers.google.com/tag-manager/serverside/common-event-data
  eventModel.ip_override = getRemoteAddress();
  eventModel.user_agent = getRequestHeader('user-agent');


  // Mapping Facebook specific cookies
  if(params.fbp) eventModel['x-fb-ck-fbp'] = params.fbp;
  if(params.fbc) eventModel['x-fb-ck-fbc'] = params.fbc;

  // Mapping Facebook AAM parameters as customer information parameters.
  // For more details on Advanced matching parameters : https://developers.facebook.com/docs/facebook-pixel/advanced/advanced-matching/
  if(params['ud[em]']) eventModel['x-fb-ud-em'] = params['ud[em]'];
  if(params['ud[ph]']) eventModel['x-fb-ud-ph'] = params['ud[ph]'];
  if(params['ud[fn]']) eventModel['x-fb-ud-fn'] = params['ud[fn]'];
  if(params['ud[ln]']) eventModel['x-fb-ud-ln'] = params['ud[ln]'];
  if(params['ud[ge]']) eventModel['x-fb-ud-ge'] = params['ud[ge]'];
  if(params['ud[db]']) eventModel['x-fb-ud-db'] = params['ud[db]'];
  if(params['ud[ct]']) eventModel['x-fb-ud-ct'] = params['ud[ct]'];
  if(params['ud[st]']) eventModel['x-fb-ud-st'] = params['ud[st]'];
  if(params['ud[zp]']) eventModel['x-fb-ud-zp'] = params['ud[zp]'];
  if(params['ud[cn]']) eventModel['x-fb-ud-country'] = params['ud[cn]'];
  if(params['ud[external_id]']) eventModel['x-fb-ud-external_id'] = params['ud[external_id]'];
  if(params['cd[subscription_id]']) eventModel['x-fb-ud-subscription_id'] = params['cd[subscription_id]'];

  // Mapping custom data parameters
  if(params['cd[value]']) eventModel.value = params['cd[value]'];
  if(params['cd[currency]']) eventModel.currency = params['cd[currency]'];
  if(params['cd[search_string]']) eventModel.search_term = params['cd[search_string]'];

  if(params['cd[content_category]']) eventModel['x-fb-cd-content_category'] = params['cd[content_category]'];
  if(params['cd[content_ids]']) eventModel['x-fb-cd-content_ids'] = params['cd[content_ids]'];
  if(params['cd[content_name]']) eventModel['x-fb-cd-content_name'] = params['cd[content_name]'];
  if(params['cd[content_type]']) eventModel['x-fb-cd-content_type'] = params['cd[content_type]'];
  if(params['cd[contents]']) eventModel['x-fb-cd-contents'] = params['cd[contents]'];
  if(params['cd[num_items]']) eventModel['x-fb-cd-num_items'] = params['cd[num_items]'];
  if(params['cd[predicted_ltv]']) eventModel['x-fb-cd-predicted_ltv'] = params['cd[predicted_ltv]'];
  if(params['cd[status]']) eventModel['x-fb-cd-status'] = params['cd[status]'];
  if(params['cd[delivery_category]']) eventModel['x-fb-cd-delivery_category'] = params['cd[delivery_category]'];

  // For pixel events, action_source defaults to Website
  eventModel.action_source = 'website';

  // Starts the  container to run the tag.
  runContainer(eventModel, () => {
    // on success callback sends standard response.
    setPixelResponse();
    returnResponse();
  });

  logToConsole('Processed /tr event!');
}

data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://connect.facebook.net/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: On /tr request, Client runs container and generates eventModel tr fields mapped
  code: |-
    // Act
    runCode(mockConfigurationData);

    // Assert
    assertThat(actualEventModel).isEqualTo(expectedEventModel);
    assertApi('getRemoteAddress').wasCalled();
    assertApi('claimRequest').wasCalled();
    assertApi('getRequestHeader').wasCalledWith('user-agent');
    assertApi('getRequestPath').wasCalled();
    assertApi('getRequestQueryParameters').wasCalled();
    assertApi('setPixelResponse').wasCalled();
    assertApi('returnResponse').wasCalled();
- name: On Http Post requset, Client processes the request body and generates eventModel
  code: |-
    mock('getRequestMethod', () => {
      return 'POST';
    });

    mock('getRequestBody', () => {
      return JSON.stringify(testTrackingRequest);
    });

    // Act
    runCode(mockConfigurationData);

    // Assert
    assertThat(actualEventModel).isEqualTo(expectedEventModel);
    assertApi('getRequestMethod').wasCalled();
- name: On /collect request, Facebook Client does not claim Request
  code: |-
    mock('getRequestPath', () => {
      return '/collect';
    });

    // Act
    runCode(mockConfigurationData);

    // Assert
    assertApi('claimRequest').wasNotCalled();
    assertApi('runContainer').wasNotCalled();
- name: On Non-matching route request, Facebook Client does not claim Request
  code: |-
    mock('getRequestPath', () => {
      return '/non-matching-route';
    });

    // Act
    runCode(mockConfigurationData);

    // Assert
    assertApi('claimRequest').wasNotCalled();
    assertApi('runContainer').wasNotCalled();
- name: Client proxies requests for fbevents JS when it isn't cached
  code: |-
    mock('getRequestPath', () => {
      return '/en_US/fbevents.js';
    });

    runCode(mockConfigurationData);

    const expectedBody = 'const events = "js";';
    const expectedStatusCode = 200;
    const expectedHeaders = {
      'header-key1': 'value1',
      'header-key2': 'value2',
    };
    capturedGetHandler(expectedStatusCode, expectedHeaders, expectedBody);

    assertApi('claimRequest').wasCalled();
    assertThat(actualGetUrl).isEqualTo('https://connect.facebook.net/en_US/fbevents.js');
    assertThat(actualOptions).isEqualTo({timeout: 5000});
    assertApi('setResponseStatus').wasCalledWith(expectedStatusCode);
    assertApi('setResponseBody').wasCalledWith(expectedBody);
    assertApi('setResponseHeader').wasCalledWith('header-key1', 'value1');
    assertApi('setResponseHeader').wasCalledWith('header-key2', 'value2');
    assertApi('returnResponse').wasCalled();
    assertThat(templateDataStorage.getItemCopy('fbevents_stored_at')).isEqualTo(currentTimeMillis);
    assertThat(templateDataStorage.getItemCopy('fbevents_js')).isEqualTo(expectedBody);
    assertThat(templateDataStorage.getItemCopy('fbevents_headers')).isEqualTo(expectedHeaders);
- name: Client returns cached fbevents JS
  code: |
    mock('getRequestPath', () => {
      return '/en_US/fbevents.js';
    });

    const expectedCachedJS = 'const events = "js";';
    const expectedCachedHeaders = {'k1': 'v1', 'k2': 'v2'};
    templateDataStorage.setItemCopy('fbevents_stored_at', currentTimeMillis);
    templateDataStorage.setItemCopy('fbevents_js', expectedCachedJS);
    templateDataStorage.setItemCopy('fbevents_headers', expectedCachedHeaders);

    runCode(mockConfigurationData);

    assertApi('claimRequest').wasCalled();
    assertApi('sendHttpGet').wasNotCalled();
    assertApi('setResponseStatus').wasCalledWith(200);
    assertApi('setResponseBody').wasCalledWith(expectedCachedJS);
    assertApi('setResponseHeader').wasCalledWith('k1', 'v1');
    assertApi('setResponseHeader').wasCalledWith('k2', 'v2');
    assertApi('returnResponse').wasCalled();
- name: Client reloads fbevents JS when it is older than 20 minutes
  code: |
    mock('getRequestPath', () => {
      return '/en_US/fbevents.js';
    });

    const hourAgoMillis = currentTimeMillis - (60 * 60 * 1000);
    const expectedBody = 'const events = "js";';
    const expectedHeaders = {'k1': 'v1'};

    templateDataStorage.setItemCopy('fbevents_stored_at', hourAgoMillis);
    templateDataStorage.setItemCopy('fbevents_js', expectedBody);
    mock('getRequestPath', () => {
      return '/en_US/fbevents.js';
    });

    runCode(mockConfigurationData);

    const expectedStatusCode = 200;
    capturedGetHandler(expectedStatusCode, expectedHeaders, expectedBody);

    assertApi('claimRequest').wasCalled();
    assertThat(actualGetUrl).isEqualTo('https://connect.facebook.net/en_US/fbevents.js');
    assertThat(actualOptions).isEqualTo({timeout: 5000});
    assertApi('setResponseStatus').wasCalledWith(expectedStatusCode);
    assertApi('setResponseBody').wasCalledWith(expectedBody);
    assertApi('setResponseHeader').wasCalledWith('k1', 'v1');
    assertApi('returnResponse').wasCalled();
    assertThat(templateDataStorage.getItemCopy('fbevents_stored_at')).isEqualTo(currentTimeMillis);
    assertThat(templateDataStorage.getItemCopy('fbevents_js')).isEqualTo(expectedBody);
    assertThat(templateDataStorage.getItemCopy('fbevents_headers')).isEqualTo(expectedHeaders);
- name: Calls gtmOnSuccess() at the end of processing
  code: |-
    mock('gtmOnSuccess');

    // Call runCode to run the template's code.
    runCode(testData);

    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  // Arrange
  const makeInteger = require('makeInteger');
  const JSON = require('JSON');

  const mockConfigurationData = {
    'config': 'value'
  };

  const testData = {
    event_name : 'test_event_name',
    time_stamp : 123456789,
    event_id : '1234',
    dl: 'www.example.com/foo.html',
    ip_address : '1.2.3.4',
    user_agent : 'test_browser_agent',
    email : 'foo@bar.com',
    phone_number: '123',
    first_name: 'foo',
    last_name: 'bar',
    gender: 'm',
    date_of_birth: '19910526',
    city: 'menlopark',
    state: 'ca',
    zip: '12345',
    country: 'us',
    external_id: 'user123',
    subscription_id: 'abc123',
    currency: 'usd',
    value: '123',
    content_category: 'product',
    content_ids: ['ABC123', 'XYZ789'],
    content_name: 'SampleItem',
    content_type: 'product',
    contents: [{'id': 'ABC123', 'quantity': 2}, {'id': 'XYZ789', 'quantity': 2}],
    num_items: 4,
    predicted_ltv: 101,
    search_string: 'query',
    status: 'subscribed',
    delivery_category: 'in_store',
    test_event_code: '123',
  };

  const testTrackingRequest = {
    ev: testData.event_name,
    ts: testData.time_stamp,
    eid: testData.event_id,
    test_event_code: testData.test_event_code,
    dl: testData.dl,
    'ud[em]' : testData.email,
    'ud[ph]' : testData.phone_number,
    'ud[fn]' : testData.first_name,
    'ud[ln]' : testData.last_name,
    'ud[ge]' : testData.gender,
    'ud[db]' : testData.date_of_birth,
    'ud[ct]' : testData.city,
    'ud[st]' : testData.state,
    'ud[zp]' : testData.zip,
    'ud[cn]' : testData.country,
    'ud[external_id]' : testData.external_id,
    'cd[currency]' : testData.currency,
    'cd[value]' : testData.value,
    'cd[content_category]' : testData.content_category,
    'cd[content_ids]' : testData.content_ids,
    'cd[content_name]' : testData.content_name,
    'cd[content_type]' : testData.content_type,
    'cd[contents]' : testData.contents,
    'cd[num_items]' : testData.num_items,
    'cd[predicted_ltv]' : testData.predicted_ltv,
    'cd[search_string]' : testData.search_string,
    'cd[status]' : testData.status,
    'cd[delivery_category]' : testData.delivery_category,
    'cd[subscription_id]' : testData.subscription_id,
  };

  const expectedEventModel = {
    'event_name': testData.event_name,
    'event_time': makeInteger(testData.time_stamp/1000),
    'event_id': testData.event_id,
    'page_location': testData.dl,
    'ip_override': testData.ip_address,
    'user_agent': testData.user_agent,
    'test_event_code': testData.test_event_code,
    'action_source': 'website',

    // user data section
    'x-fb-ud-em': testData.email,
    'x-fb-ud-ph': testData.phone_number,
    'x-fb-ud-ln': testData.last_name,
    'x-fb-ud-fn': testData.first_name,
    'x-fb-ud-ge': testData.gender,
    'x-fb-ud-db': testData.date_of_birth,
    'x-fb-ud-ct': testData.city,
    'x-fb-ud-st': testData.state,
    'x-fb-ud-zp': testData.zip,
    'x-fb-ud-country': testData.country,
    'x-fb-ud-external_id': testData.external_id,
    'x-fb-ud-subscription_id': testData.subscription_id,

    // common custom data fields that are defined already
    'currency': testData.currency,
    'value': testData.value,
    'search_term': testData.search_string,

    // Fields that don't have a mapping already will be defined as fb specific.
    'x-fb-cd-content_category': testData.content_category,
    'x-fb-cd-content_ids': testData.content_ids,
    'x-fb-cd-content_name': testData.content_name,
    'x-fb-cd-content_type': testData.content_type,
    'x-fb-cd-contents': testData.contents,
    'x-fb-cd-num_items': testData.num_items,
    'x-fb-cd-predicted_ltv': testData.predicted_ltv,
    'x-fb-cd-status': testData.status,
    'x-fb-cd-delivery_category': testData.delivery_category,
  };

  mock('getRequestPath', () => {
    return '/tr';
  });

  mock('getRemoteAddress', () => {
    return testData.ip_address;
  });

  mock('getRequestHeader', header => {
    if(header === 'user-agent') return testData.user_agent;
  });

  mock('getRequestPath', () => {
    return '/tr';
  });

  mock('getRequestQueryParameters', () => {
    return testTrackingRequest;
  });

  mock('claimRequest', () => {
    return {};
  });

  mock('setPixelResponse');
  mock('returnResponse');
  mock('claimRequest');


  let actualEventModel;
  mock('runContainer', (calledEventModel, onComplete) => {
      actualEventModel = calledEventModel;
      onComplete();
    });


  let capturedGetHandler;
  let actualGetUrl;
  let actualOptions;
  mock('sendHttpGet', (url, getHandler, options) => {
    actualGetUrl = url;
    capturedGetHandler = getHandler;
    actualOptions = options;
  });

  mock('setResponseStatus');
  mock('setResponseBody');
  mock('setResponseHeader');

  const currentTimeMillis = 1599702991120;
  mock('getTimestampMillis', () => {
    return currentTimeMillis;
  });

  const templateDataStorage = require('templateDataStorage');
  templateDataStorage.clear();


___NOTES___

Created on 8/5/2020, 10:20:28 AM
